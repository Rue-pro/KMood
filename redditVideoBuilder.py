from moviepy.editor import *

data = [
    {
        "level": "level 1",
        "author": "tbama11",
        "timestamp": "5 days ago",
        "contentArr": [
            {
                "text": " 1. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "record":
                    "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "duration": "00:00:02",
            },
            {
                "text": " 2. He was born on August 14, 2002, in Hawaii",
                "record": "1. He was born on August 14, 2002, in Hawaii",
                "duration": "00:00:02",
            },
            {
                "text": " 3. Kai's passion for music started at a young age",
                "record": "2. Kai's passion for music started at a young age",
                "duration": "00:00:02",
            },
            {
                "text": " 4. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "record":
                    "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "duration": "00:00:02",
            },
            {
                "text": " 5. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "record":
                    "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "duration": "00:00:02",
            },
            {
                "text": " 6. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "record":
                    "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "duration": "00:00:02",
            },
            {
                "text": " 7. But before we start, don't forget to like and subscribe to support our channel",
                "record":
                    "6. But before we start, don't forget to like and subscribe to support our channel",
                "duration": "00:00:02",
            },
            {
                "text": " 8. Kai's net worth is estimated at $2,000,000",
                "record": "7.Kai's net worth is estimated at $2,000,000",
                "duration": "00:00:02",
            },
            {
                "text": " 9. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "record":
                    "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "duration": "00:00:02",
            },
            {
                "text": " 10. He was born on August 14, 2002, in Hawaii",
                "record": "1. He was born on August 14, 2002, in Hawaii",
                "duration": "00:00:02",
            },
            {
                "text": " 11. Kai's passion for music started at a young age",
                "record": "2. Kai's passion for music started at a young age",
                "duration": "00:00:02",
            },
            {
                "text": " 12. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "record":
                    "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "duration": "00:00:02",
            },
            {
                "text": " 13. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "record":
                    "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "duration": "00:00:02",
            },
            {
                "text": " 14. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "record":
                    "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "duration": "00:00:02",
            },
            {
                "text": " 15. But before we start, don't forget to like and subscribe to support our channel",
                "record":
                    "6. But before we start, don't forget to like and subscribe to support our channel",
                "duration": "00:00:02",
            },
            {
                "text": "16. Kai's net worth is estimated at $2,000,000",
                "record": "7.Kai's net worth is estimated at $2,000,000",
                "duration": "00:00:02",
            },
        ],
        "rating": "16.8k",
        "replies": [
            {
                "level": "level 2",
                "author": "tbama12",
                "timestamp": "10 days ago",
                "contentArr": [
                    {
                        "text": " 21. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "record":
                            "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 22. He was born on August 14, 2002, in Hawaii",
                        "record": "1. He was born on August 14, 2002, in Hawaii",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 23. Kai's passion for music started at a young age",
                        "record": "2. Kai's passion for music started at a young age",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 24. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "record":
                            "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 25. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "record":
                            "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 26. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "record":
                            "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 27. But before we start, don't forget to like and subscribe to support our channel",
                        "record":
                            "6. But before we start, don't forget to like and subscribe to support our channel",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 28. Kai's net worth is estimated at $2,000,000",
                        "record": "7.Kai's net worth is estimated at $2,000,000",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 29. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "record":
                            "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 210. He was born on August 14, 2002, in Hawaii",
                        "record": "1. He was born on August 14, 2002, in Hawaii",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 211. Kai's passion for music started at a young age",
                        "record": "2. Kai's passion for music started at a young age",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 212. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "record":
                            "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 213. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "record":
                            "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 214. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "record":
                            "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 215. But before we start, don't forget to like and subscribe to support our channel",
                        "record":
                            "6. But before we start, don't forget to like and subscribe to support our channel",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 216. Kai's net worth is estimated at $2,000,000",
                        "record": "7.Kai's net worth is estimated at $2,000,000",
                        "duration": "00:00:02",
                    },
                ],
                "rating": "631",
                "replies": 0
            }
        ]
    },
];

videoBorder = 50
videoWidth = 1920
videoHeight = 1080
videoViewportWidth = videoWidth - videoBorder * 2
videoViewportHeight = videoHeight - videoBorder * 2

comments_gap = 32
comment_margin_top = 16
controls_margin_top = 16


def createPage():
    return ColorClip((videoWidth, videoHeight), (255, 255, 255), duration=1)


def createAuthor(author, margin_top):
    author_clip = TextClip(author, fontsize=30, font="IBM Plex Sans-Bold", color='rgb(124, 124, 124)')
    return author_clip, author_clip.size[1] + margin_top


def createTimestamp(timestamp, margin_top):
    timestamp_clip = TextClip(timestamp, fontsize=30, font="Noto Sans", color='rgb(124, 124, 124)')
    return timestamp_clip, timestamp_clip.size[1] + margin_top


def createComment(commentDivided, last_comment_index, margin_top):
    sentences = ""
    for sentence in commentDivided[0:last_comment_index]:
        sentences += sentence["text"]

    comment_clip = TextClip(sentences, size=(videoWidth - videoBorder * 2, None), fontsize=60,
                            font="IBM Plex Sans", color='rgb(124, 124, 124)', method="caption", align="West")
    return comment_clip, comment_clip.size[1] + margin_top


def createControl(control, margin_top):
    control_clip = TextClip(control, fontsize=30, font="IBM Plex Sans-Bold", color='rgb(124, 124, 124)')
    return control_clip, control_clip.size[1] + margin_top


def getSecondsFromTime(time):
    hours = int(time[0:2])
    minutes = int(time[3:5])
    seconds = int(time[6:8])

    return hours * 60 * 60 + minutes * 60 + seconds


def addToPages(pages, page, sentence):
    print("Add to pages...", pages)
    print(sentence)
    print("page.duration", page.duration)
    pages.append(page)


class RedditVideoBuilder:

    def __init__(self):
        self.lastItemPosition = videoBorder
        self.pages = []

    def _getLastPage(self):
        if len(self.pages) == 0:
            lastPage = None
        else:
            lastPage = self.pages[len(self.pages) - 1]
        return lastPage

    def calculateContent(self, commentDivided, is_continuing=False):
        print("Do calculate content...")
        author_clip, comment_height_author = createAuthor("Test Author", self.lastItemPosition)
        if is_continuing:
            comment_height_author = self.lastItemPosition
        comment_height_author += comment_margin_top  # add margin between author and comment

        control_clip, comment_height_author_plus_control = createControl(
            "Test Control",
            comment_height_author + controls_margin_top
        )

        comment_clip, comment_height_author_plus_comment_plus_control = createComment(
            commentDivided,
            last_comment_index=len(commentDivided),
            margin_top=comment_height_author_plus_control
        )

        if comment_height_author > videoViewportHeight:
            return commentDivided, []

        last_sentence = 1
        if comment_height_author_plus_comment_plus_control > videoViewportHeight:
            while True:
                comment_clip, comment_height_author_plus_comment_plus_control = createComment(
                    commentDivided,
                    last_comment_index=last_sentence,
                    margin_top=comment_height_author_plus_control
                )
                if comment_height_author_plus_comment_plus_control > videoViewportHeight:
                    break
                else:
                    last_sentence += 1
        else:
            last_sentence = len(commentDivided)

        divided_comments_on_current_page = commentDivided[0: last_sentence]
        if len(commentDivided) == last_sentence:
            divided_comments_on_next_page = []
        else:
            divided_comments_on_next_page = commentDivided[last_sentence: len(commentDivided)]

        return divided_comments_on_current_page, divided_comments_on_next_page

    def _addAuthorAndTimeStamp(self, author, timestamp):
        gap = videoBorder

        author_clip, comment_height_author = createAuthor(author, self.lastItemPosition)
        author_clip = author_clip.set_position((gap, self.lastItemPosition))

        gap += author_clip.size[0] + 16

        timestamp_clip, comment_height_timestamp = createTimestamp(timestamp, self.lastItemPosition)
        timestamp_clip = timestamp_clip.set_position((gap, self.lastItemPosition))

        self.lastItemPosition += author_clip.size[1]

        return author_clip, timestamp_clip

    def _addComment(self, commentDivided):
        final_duration = 0
        comment_clips = []
        for index, sentence in enumerate(commentDivided):
            comment_clip, comment_height_author_plus_comment = createComment(
                commentDivided,
                last_comment_index=index + 1,
                margin_top=0
            )
            duration = getSecondsFromTime(sentence["duration"])
            final_duration += duration
            comment_clip = comment_clip.set_duration(duration)
            comment_clips.append(comment_clip)

        final_clip = concatenate_videoclips(comment_clips)
        final_clip = final_clip.set_position((videoBorder, self.lastItemPosition + comment_margin_top))
        print("final_clip.duration", final_clip.duration)
        print("calculated duration, final_duration")
        self.lastItemPosition += comment_clip.size[1]

        return final_clip, final_duration

    def _addControls(self):
        control_clip, control_height = createControl("Reply", margin_top=0)
        control_clip = control_clip.set_position((videoBorder, self.lastItemPosition + controls_margin_top))

        self.lastItemPosition += control_clip.size[1]
        print("lastItemPosition controls", self.lastItemPosition)

        return control_clip

    def _addRestPartOfComment(self, divided_comments):
        print("Do add next page...", divided_comments)
        self.lastItemPosition = videoBorder
        divided_comments_on_current_page, divided_comments_on_next_page = self.calculateContent(divided_comments)
        comment_clip, comment_clip_duration = self._addComment(divided_comments_on_current_page)
        page_bg = createPage()
        page_bg = page_bg.set_duration(comment_clip_duration)

        if len(divided_comments_on_next_page) == 0:
            print("Comment height is OK")
            control_clip = self._addControls()
            control_clip = control_clip.set_duration(comment_clip_duration)
            page = CompositeVideoClip([page_bg, comment_clip, control_clip])
            page.write_videofile(
                "rest_no_next_page_last_page_is_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                fps=25)

            self.pages.append({
                "comment": page,
                "pageRows": [{
                    "type": "comment",
                    "source": comment_clip
                }, {
                    "type": "control",
                    "source": control_clip
                }],
                "finished": False,
            })
        else:
            print("Comment height is NOT OK, do divide")
            page = CompositeVideoClip([page_bg, comment_clip])
            page.write_videofile(
                "rest_have_next_page_last_page_is_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                fps=25)
            self.pages.append({
                "comment": page,
                "pageRows": [{
                    "type": "comment",
                    "source": comment_clip
                }],
                "finished": True
            })
            self._addRestPartOfComment(divided_comments_on_next_page)

    def _addNewComment(self, _page, comment_data):
        [author_clip, timestamp_clip] = self._addAuthorAndTimeStamp(
            comment_data["author"],
            comment_data["timestamp"]
        )
        divided_comments_on_current_page, divided_comments_on_next_page = self.calculateContent(
            comment_data["contentArr"])  # get current page sentences
        comment_clip, comment_clip_duration = self._addComment(divided_comments_on_current_page)
        author_clip = author_clip.set_duration(comment_clip_duration)
        timestamp_clip = timestamp_clip.set_duration(comment_clip_duration)

        lastPage = self._getLastPage()

        if len(divided_comments_on_next_page) == 0:
            print("Comment height is OK, finish comment")
            control_clip = self._addControls()
            control_clip = control_clip.set_duration(comment_clip_duration)

            if lastPage is not None and lastPage["finished"] == False:
                print("No next page, last page is not finished")

                lastComment = self.pages[len(self.pages) - 1]["comment"]
                prevVideoLastFrame = lastComment.subclip([0, -1])
                bg_page = []
                for duration in range(comment_clip_duration):
                    bg_page.append(prevVideoLastFrame)
                bg_page = concatenate_videoclips(bg_page)
                page = CompositeVideoClip([bg_page, author_clip, timestamp_clip, comment_clip, control_clip])
                page.write_videofile(
                    "no_next_page_last_page_is_not_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                    fps=25)

                newPageRows = self.pages[len(self.pages) - 1]["pageRows"]
                newPageRows.append({
                    "type": "author",
                    "source": author_clip
                })
                newPageRows.append({
                    "type": "timestamp",
                    "source": timestamp_clip
                })
                newPageRows.append({
                    "type": "comment",
                    "source": comment_clip
                })
                newPageRows.append({
                    "type": "control",
                    "source": control_clip
                })

                self.pages[len(self.pages) - 1] = {
                    "sentence": divided_comments_on_current_page[0]["text"],
                    "comment": page,
                    "pageRows": newPageRows,
                    "finished": False
                }
            else:
                print("No next page, last page is finished")
                page_bg = createPage()
                page_bg = page_bg.set_duration(comment_clip_duration)

                page = CompositeVideoClip([page_bg, author_clip, timestamp_clip, comment_clip, control_clip])
                page.write_videofile(
                    "no_next_page_last_page_is_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                    fps=25)

                self.pages.append({
                    "sentence": divided_comments_on_current_page[0]["text"],
                    "comment": page,
                    "pageRows": [{
                        "type": "author",
                        "source": author_clip
                    }, {
                        "type": "timestamp",
                        "source": timestamp_clip
                    }, {
                        "type": "comment",
                        "source": comment_clip
                    }, {
                        "type": "control",
                        "source": control_clip
                    }],
                    "finished": False
                })
        else:
            print("Comment height is NOT OK, do divide")
            if lastPage is not None and lastPage["finished"] == False:
                print("Have next page, last page is not finished")

                lastComment = self.pages[len(self.pages) - 1]["comment"]
                prevVideoLastFrame = lastComment.subclip([0, -1])
                bg_page = []
                for duration in range(comment_clip_duration):
                    bg_page.append(prevVideoLastFrame)
                bg_page = concatenate_videoclips(bg_page)
                page = CompositeVideoClip([bg_page, author_clip, timestamp_clip, comment_clip])
                page.write_videofile(
                    "have_next_page_last_page_is_not_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                    fps=25)

                newPageRows = self.pages[len(self.pages) - 1]["pageRows"]

                newPageRows.append({
                    "type": "author",
                    "source": author_clip
                })
                newPageRows.append({
                    "type": "timestamp",
                    "source": timestamp_clip
                })
                newPageRows.append({
                    "type": "comment",
                    "source": comment_clip
                })

                self.pages[len(self.pages) - 1] = {
                    "sentence": divided_comments_on_current_page[0]["text"],
                    "comment": page,
                    "pageRows": newPageRows,
                    "finished": True
                }
            else:
                print("Have next page, last page is finished")

                page_bg = createPage()
                page_bg = page_bg.set_duration(comment_clip_duration)

                page = CompositeVideoClip([page_bg, author_clip, timestamp_clip, comment_clip])
                page.write_videofile(
                    "have_next_page_last_page_is_finished_" + divided_comments_on_current_page[0]["text"] + ".mp4",
                    fps=25)

                self.pages.append({
                    "sentence": divided_comments_on_current_page[0]["text"],
                    "comment": page,
                    "pageRows": [{
                        "type": "author",
                        "source": author_clip
                    }, {
                        "type": "timestamp",
                        "source": timestamp_clip
                    }, {
                        "type": "comment",
                        "source": comment_clip
                    }],
                    "finished": True
                })

            self._addRestPartOfComment(divided_comments_on_next_page)

    def build(self):
        comment_data = data[0]
        page = createPage()
        self._addNewComment(page, comment_data)
        for comment_data in comment_data["replies"]:
            self._addNewComment(page, comment_data)

        filesToConcatenate = []

        print("self.pages", self.pages)
        filesToConcatenateTest = []
        for comment_page_index, comment_page in enumerate(self.pages):
            print("comment_page", comment_page)
            filesToConcatenateTest.append(comment_page["comment"])

            page_bg = createPage()
            filesToComposite = []
            page_duration = 0
            for comment_page_row_index, row in enumerate(comment_page["pageRows"]):
                print("comment_page_row_index", comment_page_row_index)
                print("row", row)
                source = row["source"]
                if comment_page_row_index == 0:
                    filesToComposite.append(source)
                else:
                    if row["type"] == "author":
                        page_bg = page_bg.set_duration(page_duration)
                        filesToComposite.insert(0, page_bg)
                        print("filesToComposite create videofile", filesToComposite)
                        if len(filesToConcatenate) != 0:
                            prevVideo = filesToConcatenate[len(filesToConcatenate) - 1]
                            prevVideoLastFrame = prevVideo.subclip([0, -1])
                            for dur in range(page_duration):
                                filesToComposite.insert(0, prevVideoLastFrame)
                        test = CompositeVideoClip(filesToComposite)
                        test.write_videofile(
                            "test_" + str(comment_page_index) + "_" + str(comment_page_row_index) + "_.mp4", fps=25)
                        filesToConcatenate.append(test)
                        page_duration = 0
                        filesToComposite = []
                    filesToComposite.append(source)

                if row["type"] == "comment":
                    page_duration += source.duration

            page_bg = page_bg.set_duration(page_duration)
            filesToComposite.insert(0, page_bg)
            if comment_page["finished"] == False and len(filesToConcatenate) != 0:
                prevVideo = filesToConcatenate[len(filesToConcatenate) - 1]
                prevVideoLastFrame = prevVideo.subclip([0, -1])
                for dur in range(page_duration):
                    filesToComposite.insert(0, prevVideoLastFrame)
            test = CompositeVideoClip(filesToComposite)
            test.write_videofile("test_" + str(comment_page_index) + "_" + str(comment_page_row_index) + "_.mp4",
                                 fps=25)
            filesToConcatenate.append(test)

        print("filesToConcatenate", filesToConcatenate)

        final = concatenate_videoclips(filesToConcatenate)
        final.write_videofile("redditVideoBuilder.mp4", fps=25)

        finalTest = concatenate_videoclips(filesToConcatenateTest)
        finalTest.write_videofile("redditVideoBuilderTest.mp4", fps=25)
