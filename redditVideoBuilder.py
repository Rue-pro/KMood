from moviepy.editor import *

data = [
    {
        "level": "level 1",
        "author": "tbama11",
        "timestamp": "5 days ago",
        "contentArr": [
            {
                "text": " 1. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "record":
                    "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "duration": "00:00:02",
            },
            {
                "text": " 2. He was born on August 14, 2002, in Hawaii",
                "record": "1. He was born on August 14, 2002, in Hawaii",
                "duration": "00:00:02",
            },
            {
                "text": " 3. Kai's passion for music started at a young age",
                "record": "2. Kai's passion for music started at a young age",
                "duration": "00:00:02",
            },
            {
                "text": " 4. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "record":
                    "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "duration": "00:00:02",
            },
            {
                "text": " 5. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "record":
                    "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "duration": "00:00:02",
            },
            {
                "text": " 6. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "record":
                    "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "duration": "00:00:02",
            },
            {
                "text": " 7. But before we start, don't forget to like and subscribe to support our channel",
                "record":
                    "6. But before we start, don't forget to like and subscribe to support our channel",
                "duration": "00:00:02",
            },
            {
                "text": " 8. Kai's net worth is estimated at $2,000,000",
                "record": "7.Kai's net worth is estimated at $2,000,000",
                "duration": "00:00:02",
            },
            {
                "text": " 9. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "record":
                    "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                "duration": "00:00:02",
            },
            {
                "text": " 10. He was born on August 14, 2002, in Hawaii",
                "record": "1. He was born on August 14, 2002, in Hawaii",
                "duration": "00:00:02",
            },
            {
                "text": " 11. Kai's passion for music started at a young age",
                "record": "2. Kai's passion for music started at a young age",
                "duration": "00:00:02",
            },
            {
                "text": " 12. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "record":
                    "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                "duration": "00:00:02",
            },
            {
                "text": " 13. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "record":
                    "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                "duration": "00:00:02",
            },
            {
                "text": " 14. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "record":
                    "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                "duration": "00:00:02",
            },
            {
                "text": " 15. But before we start, don't forget to like and subscribe to support our channel",
                "record":
                    "6. But before we start, don't forget to like and subscribe to support our channel",
                "duration": "00:00:02",
            },
            {
                "text": "16. Kai's net worth is estimated at $2,000,000",
                "record": "7.Kai's net worth is estimated at $2,000,000",
                "duration": "00:00:02",
            },
        ],
        "rating": "16.8k",
        "replies": [
            {
                "level": "level 2",
                "author": "tbama12",
                "timestamp": "10 days ago",
                "contentArr": [
                    {
                        "text": " 21. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "record":
                            "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 22. He was born on August 14, 2002, in Hawaii",
                        "record": "1. He was born on August 14, 2002, in Hawaii",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 23. Kai's passion for music started at a young age",
                        "record": "2. Kai's passion for music started at a young age",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 24. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "record":
                            "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 25. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "record":
                            "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 26. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "record":
                            "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 27. But before we start, don't forget to like and subscribe to support our channel",
                        "record":
                            "6. But before we start, don't forget to like and subscribe to support our channel",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 28. Kai's net worth is estimated at $2,000,000",
                        "record": "7.Kai's net worth is estimated at $2,000,000",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 29. Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "record":
                            "0.Huening Kai is a multitalented artist and member of the popular K-Pop group TXT",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 210. He was born on August 14, 2002, in Hawaii",
                        "record": "1. He was born on August 14, 2002, in Hawaii",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 211. Kai's passion for music started at a young age",
                        "record": "2. Kai's passion for music started at a young age",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 212. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "record":
                            "3. Growing up, he lived in many different countries, including Brazil, Germany, and China, which gave him a unique perspective on the world and influenced his artistry",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 213. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "record":
                            "4. Today, he is known for his powerful vocals, impressive musicianship, and charming personality, which have made him a beloved member of the K-Pop community",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 214. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "record":
                            "5. Today we'll take a closer look at Huening Kai's life, career, and achievements",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 215. But before we start, don't forget to like and subscribe to support our channel",
                        "record":
                            "6. But before we start, don't forget to like and subscribe to support our channel",
                        "duration": "00:00:02",
                    },
                    {
                        "text": " 216. Kai's net worth is estimated at $2,000,000",
                        "record": "7.Kai's net worth is estimated at $2,000,000",
                        "duration": "00:00:02",
                    },
                ],
                "rating": "631",
                "replies": 0
            }
        ]
    },
];

projectPath = "C:\Dev\YouTube Automation\KMood\TXT_Kai\Speech\Audios\Cropped\\"

videoBorder = 50
videoWidth = 1920
videoHeight = 1080
videoViewportWidth = videoWidth - videoBorder * 2
videoViewportHeight = videoHeight - videoBorder * 2

comments_gap = 16 * 3
comment_margin_top = 16
controls_margin_top = 16
divider_width = 4
dividers_gap = 8 * 2


def getLevel(level):
    print("level: ", int(level[6: len(level)]))
    return int(level[6: len(level)])


def createPage():
    return ColorClip((videoWidth, videoHeight), (255, 255, 255), duration=1)


def createDivider(height):
    return ColorClip((divider_width, height + 10), (237, 239, 241), duration=1)


def createAuthor(author, margin_top):
    author_clip = TextClip(author, fontsize=30, font="IBM Plex Sans-Bold", color='rgb(26, 26, 27)')
    return author_clip, author_clip.size[1] + margin_top


def createTimestamp(timestamp, margin_top):
    timestamp_clip = TextClip(timestamp, fontsize=30, font="Noto Sans", color='rgb(116, 117, 118)')
    return timestamp_clip, timestamp_clip.size[1] + margin_top


def createComment(commentDivided, last_comment_index, margin_top, margin_left):
    print("create comment margin left: ", margin_left)
    sentences = ""
    for sentence in commentDivided[0:last_comment_index]:
        sentences += sentence["text"]

    comment_clip = TextClip(sentences, size=(videoWidth - margin_left - videoBorder, None), fontsize=38,
                            font="IBM Plex Sans", color='rgb(26, 26, 26)', method="caption", align="West")
    return comment_clip, comment_clip.size[1] + margin_top


def createControl(control, margin_top):
    control_clip = TextClip(control, fontsize=30, font="IBM Plex Sans-Bold", color='rgb(135, 138, 140)')
    return control_clip, control_clip.size[1] + margin_top


def getSecondsFromTime(time):
    hours = int(time[0:2])
    minutes = int(time[3:5])
    seconds = int(time[6:8])

    return hours * 60 * 60 + minutes * 60 + seconds


def addToPages(pages, page, sentence):
    print("Add to pages...", pages)
    print(sentence)
    print("page.duration", page.duration)
    pages.append(page)


class RedditVideoBuilder:

    def __init__(self):
        self.lastItemPosition = videoBorder
        self.pages = []

    def _getLastPage(self):
        if len(self.pages) == 0:
            lastPage = None
        else:
            lastPage = self.pages[len(self.pages) - 1]
        return lastPage

    def _getContainerMarginTop(self):
        isLastPageHaveSomeSpace = self._getIsPageHaveSomeSpace()
        if isLastPageHaveSomeSpace:
            return comments_gap
        else:
            return 0

    def calculateContent(self, commentDivided, comment_left_margin):
        print("Do calculate content...")
        print(self.pages)
        container_margin_top = self.lastItemPosition + self._getContainerMarginTop()
        author_clip, comment_height_author = createAuthor("Test Author", container_margin_top)

        comment_height_author += comment_margin_top  # add margin between author and comment

        control_clip, comment_height_author_plus_control = createControl(
            "Test Control",
            comment_height_author + controls_margin_top
        )

        comment_clip, comment_height_author_plus_comment_plus_control = createComment(
            commentDivided,
            last_comment_index=len(commentDivided),
            margin_top=comment_height_author_plus_control,
            margin_left=comment_left_margin
        )
        print("sentence: ", commentDivided[0])
        print("comment_height_author: ", comment_height_author)
        print("comment_height_author_plus_comment_plus_control before cycle: ", comment_height_author_plus_comment_plus_control)
        if comment_height_author > videoViewportHeight:
            return [], commentDivided

        last_sentence = 1
        if comment_height_author_plus_comment_plus_control > videoViewportHeight:
            while True:
                comment_clip, comment_height_author_plus_comment_plus_control = createComment(
                    commentDivided,
                    last_comment_index=last_sentence,
                    margin_top=comment_height_author_plus_control,
                    margin_left=comment_left_margin
                )
                print("comment_height_author_plus_comment_plus_control in cycle", comment_height_author_plus_comment_plus_control)
                if comment_height_author_plus_comment_plus_control > videoViewportHeight:
                    break
                else:
                    last_sentence += 1
        else:
            last_sentence = len(commentDivided)

        divided_comments_on_current_page = commentDivided[0: last_sentence]
        if len(commentDivided) == last_sentence:
            divided_comments_on_next_page = []
        else:
            divided_comments_on_next_page = commentDivided[last_sentence: len(commentDivided)]

        return divided_comments_on_current_page, divided_comments_on_next_page

    def _addAuthorAndTimeStamp(self, author, timestamp, comment_left_margin):
        gap = comment_left_margin
        container_margin_top = self.lastItemPosition + self._getContainerMarginTop()
        print("self.lastItemPosition before author", self.lastItemPosition)
        author_clip, comment_height_author = createAuthor(author, container_margin_top)

        author_clip = author_clip.set_position((gap, container_margin_top))

        gap += author_clip.size[0] + 16

        timestamp_clip, comment_height_timestamp = createTimestamp(timestamp, container_margin_top)
        timestamp_clip = timestamp_clip.set_position((gap, container_margin_top))

        self.lastItemPosition = container_margin_top + author_clip.size[1]
        print("self.lastItemPosition after author", self.lastItemPosition)

        return author_clip, timestamp_clip, container_margin_top

    def _addComment(self, commentDivided, comment_left_margin):
        final_duration = 0
        comment_clips = []
        for index, sentence in enumerate(commentDivided):
            comment_clip, comment_height_author_plus_comment = createComment(
                commentDivided,
                last_comment_index=index + 1,
                margin_top=0,
                margin_left=comment_left_margin
            )
            duration = getSecondsFromTime(sentence["duration"])
            final_duration += duration
            comment_clip = comment_clip.set_duration(duration)
            comment_clips.append(comment_clip)

        final_clip = concatenate_videoclips(comment_clips)
        final_clip = final_clip.set_position((comment_left_margin, self.lastItemPosition + comment_margin_top))
        final_clip.audio = self._addAudio(commentDivided)

        self.lastItemPosition += comment_clip.size[1]

        return final_clip, final_duration

    def _addAudio(self, commentDivided):
        audio_clips = []
        for index, sentence in enumerate(commentDivided):
            audio_clip = AudioFileClip(projectPath + sentence["record"] + ".mp3")
            audio_clip = audio_clip.subclip(0, -2)
            audio_clips.append(audio_clip)
        final = concatenate_audioclips(audio_clips)
        return final

    def _addControls(self, comment_left_margin):
        control_clip, control_height = createControl("Reply", margin_top=0)
        control_clip = control_clip.set_position((comment_left_margin, self.lastItemPosition + controls_margin_top))
        print("self.lastItemPosition before control", self.lastItemPosition)

        self.lastItemPosition += control_clip.size[1]
        print("self.lastItemPosition after control", self.lastItemPosition)

        return control_clip

    def _addDivider(self, height):
        return createDivider(height)

    def _addRestPartOfComment(self, divided_comments, comment_left_margin):
        self.lastItemPosition = videoBorder
        divider_top_position = self.lastItemPosition
        divided_comments_on_current_page, divided_comments_on_next_page = self.calculateContent(divided_comments, comment_left_margin)
        if len(divided_comments_on_current_page) == 0:
            self._addRestPartOfComment(divided_comments_on_next_page, comment_left_margin)
            return

        comment_clip, comment_clip_duration = self._addComment(divided_comments_on_current_page, comment_left_margin)

        page_bg = createPage()
        page_bg = page_bg.set_duration(comment_clip_duration)

        if len(divided_comments_on_next_page) == 0:
            control_clip = self._addControls(comment_left_margin)
            control_clip = control_clip.set_duration(comment_clip_duration)

            divider_height = self.lastItemPosition - divider_top_position
            divider_clip = self._addDivider(divider_height).set_duration(comment_clip_duration)
            divider_clip = divider_clip.set_position((comment_left_margin - divider_width - dividers_gap, divider_top_position))

            page = CompositeVideoClip([page_bg, divider_clip, comment_clip, control_clip])
            self.pages.append({
                "comment": page,
                "finished": False,
            })
        else:
            divider_height = self.lastItemPosition - divider_top_position
            divider_clip = self._addDivider(divider_height).set_duration(comment_clip_duration)
            divider_clip = divider_clip.set_position((comment_left_margin - divider_width - dividers_gap, divider_top_position))

            page = CompositeVideoClip([page_bg, divider_clip, comment_clip])
            self.pages.append({
                "comment": page,
                "finished": True
            })
            self._addRestPartOfComment(divided_comments_on_next_page, comment_left_margin)

    def _getPageBg(self, duration):
        isLastPageHaveSomeSpace = self._getIsPageHaveSomeSpace()

        if isLastPageHaveSomeSpace:
            lastComment = self.pages[len(self.pages) - 1]["comment"]
            prevVideoLastFrame = lastComment.subclip([0, -1])
            bg_page_frames = []
            for sec in range(duration):
                bg_page_frames.append(prevVideoLastFrame)
            return concatenate_videoclips(bg_page_frames)
        else:
            page_bg = createPage()
            return page_bg.set_duration(duration)

    def _getIsPageHaveSomeSpace(self):
        lastPage = self._getLastPage()
        return lastPage is not None and not lastPage["finished"]

    def _addNewComment(self, _page, comment_data):

        level = getLevel(comment_data["level"])
        comment_left_margin = videoBorder + level * divider_width + level * dividers_gap
        print("calculated comment left margin", comment_left_margin)
        [author_clip, timestamp_clip, container_margin_top] = self._addAuthorAndTimeStamp(
            comment_data["author"],
            comment_data["timestamp"],
            comment_left_margin
        )
        divider_top_position = container_margin_top

        divided_comments_on_current_page, divided_comments_on_next_page = self.calculateContent(
            comment_data["contentArr"], comment_left_margin)  # get current page sentences

        if len(divided_comments_on_current_page) == 0:
            self._addRestPartOfComment(divided_comments_on_next_page, comment_left_margin)
            return

        comment_clip, comment_clip_duration = self._addComment(divided_comments_on_current_page, comment_left_margin)
        author_clip = author_clip.set_duration(comment_clip_duration)
        timestamp_clip = timestamp_clip.set_duration(comment_clip_duration)

        page_bg = self._getPageBg(comment_clip_duration)

        if len(divided_comments_on_next_page) == 0:
            control_clip = self._addControls(comment_left_margin)
            control_clip = control_clip.set_duration(comment_clip_duration)

            divider_height = self.lastItemPosition - divider_top_position
            divider_clip = self._addDivider(divider_height).set_duration(comment_clip_duration)
            divider_clip = divider_clip.set_position((comment_left_margin - divider_width - dividers_gap, divider_top_position))

            page = CompositeVideoClip([page_bg, divider_clip, author_clip, timestamp_clip, comment_clip, control_clip])
            self.pages.append({
                "sentence": divided_comments_on_current_page[0]["text"],
                "comment": page,
                "finished": False
            })
        else:
            print("Comment height is NOT OK, do divide")
            divider_height = self.lastItemPosition - divider_top_position
            divider_clip = self._addDivider(divider_height).set_duration(comment_clip_duration)
            divider_clip = divider_clip.set_position((comment_left_margin - divider_width - dividers_gap, divider_top_position))

            page = CompositeVideoClip([page_bg, divider_clip, author_clip, timestamp_clip, comment_clip])
            self.pages.append({
                "sentence": divided_comments_on_current_page[0]["text"],
                "comment": page,
                "finished": True
            })

            self._addRestPartOfComment(divided_comments_on_next_page, comment_left_margin)

    def build(self):
        comment_data = data[0]
        page = createPage()
        self._addNewComment(page, comment_data)
        for comment_data in comment_data["replies"]:
            self._addNewComment(page, comment_data)

        print("self.pages", self.pages)
        filesToConcatenate = []
        for comment_page_index, comment_page in enumerate(self.pages):
            filesToConcatenate.append(comment_page["comment"])

        final = concatenate_videoclips(filesToConcatenate)
        final.write_videofile("redditVideoBuilder.mp4", fps=10)
